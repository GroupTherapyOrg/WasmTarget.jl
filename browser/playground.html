<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WasmTarget.jl Playground</title>
<style>
  :root {
    --bg: #fafaf9;
    --fg: #1c1917;
    --border: #d6d3d1;
    --accent: #16a34a;
    --accent-hover: #15803d;
    --editor-bg: #ffffff;
    --output-bg: #f5f5f4;
    --error: #dc2626;
    --muted: #78716c;
    --header-bg: #292524;
    --header-fg: #fafaf9;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #1c1917;
      --fg: #fafaf9;
      --border: #44403c;
      --editor-bg: #292524;
      --output-bg: #292524;
      --header-bg: #0c0a09;
      --header-fg: #fafaf9;
      --muted: #a8a29e;
    }
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--fg);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    background: var(--header-bg);
    color: var(--header-fg);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  header h1 {
    font-size: 18px;
    font-weight: 600;
  }

  header .tag {
    font-size: 11px;
    background: var(--accent);
    color: white;
    padding: 2px 8px;
    border-radius: 9999px;
    font-weight: 500;
  }

  header .subtitle {
    font-size: 13px;
    color: var(--muted);
    margin-left: auto;
  }

  .container {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 960px;
    width: 100%;
    margin: 0 auto;
    padding: 24px;
    gap: 16px;
  }

  .toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #run-btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  #run-btn:hover { background: var(--accent-hover); }
  #run-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .status {
    font-size: 13px;
    color: var(--muted);
  }

  .status.error { color: var(--error); }
  .status.ready { color: var(--accent); }

  .editor-wrapper {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    background: var(--editor-bg);
  }

  .editor-wrapper .cm-editor {
    font-size: 14px;
    min-height: 120px;
  }

  .editor-wrapper .cm-editor .cm-content {
    font-family: "JetBrains Mono", "Fira Code", "Cascadia Code", monospace;
  }

  .editor-wrapper .cm-editor .cm-gutters {
    background: var(--output-bg);
    border-right: 1px solid var(--border);
  }

  .output-section label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  #output {
    background: var(--output-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    font-family: "JetBrains Mono", "Fira Code", monospace;
    font-size: 14px;
    min-height: 80px;
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.6;
  }

  #output .result { color: var(--fg); }
  #output .error { color: var(--error); }
  #output .info { color: var(--muted); font-style: italic; }

  .examples {
    font-size: 13px;
    color: var(--muted);
  }

  .examples code {
    background: var(--output-bg);
    border: 1px solid var(--border);
    padding: 1px 5px;
    border-radius: 4px;
    font-family: "JetBrains Mono", "Fira Code", monospace;
    font-size: 12px;
    cursor: pointer;
  }

  .examples code:hover {
    border-color: var(--accent);
  }
</style>
</head>
<body>

<header>
  <h1>WasmTarget<span style="color:#e74d3c">.</span><span style="color:#9558b2">j</span><span style="color:#389826">l</span></h1>
  <span class="tag">Playground</span>
  <span class="subtitle">Julia compiled to WebAssembly &mdash; running in your browser</span>
</header>

<div class="container">
  <div class="toolbar">
    <button id="run-btn" disabled>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
      Run
    </button>
    <span id="status" class="status">Loading WebAssembly module...</span>
  </div>

  <div class="editor-wrapper">
    <div id="editor"></div>
  </div>

  <div class="examples">
    Try:
    <code data-expr="1 + 1">1 + 1</code>
    <code data-expr="10 - 3">10 - 3</code>
    <code data-expr="2 * 3">2 * 3</code>
    <code data-expr="10 % 3">10 % 3</code>
    <code data-expr="2.5 + 3.5">2.5 + 3.5</code>
    <code data-expr="sin(1.0)">sin(1.0)</code>
    <code data-expr="sqrt(4.0)">sqrt(4.0)</code>
    <code data-expr="abs(-7)">abs(-7)</code>
    <code data-expr="max(3, 7)">max(3, 7)</code>
    <code data-expr="factorial(10)">factorial(10)</code>
    <code data-expr="fib(20)">fib(20)</code>
    <code data-expr="gcd(100, 75)">gcd(100, 75)</code>
    <code data-expr="isprime(97)">isprime(97)</code>
    <code data-expr="pow(2, 10)">pow(2, 10)</code>
    <code data-expr="sum_to(100)">sum_to(100)</code>
    <code data-expr="sign(-5)">sign(-5)</code>
    <code data-expr="clamp(15, 1, 10)">clamp(15, 1, 10)</code>
  </div>

  <div class="output-section">
    <label>Output</label>
    <div id="output"><span class="info">Click Run to evaluate Julia code.</span></div>
  </div>
</div>

<!-- WasmTargetRuntime: load as plain script (sets window.WasmTargetRuntime) -->
<script src="./wasmtarget-runtime.js"></script>

<!-- CodeMirror 6 from CDN -->
<script type="module">
import {EditorView, basicSetup} from "https://esm.sh/@codemirror/basic-setup@0.20.0";
import {EditorState} from "https://esm.sh/@codemirror/state@6.5.2";
const WasmTargetRuntime = window.WasmTargetRuntime;

// ── State ──
let wasmInstance = null;   // pipeline.wasm instance (fallback for non-supported expressions)
let rt = null;             // WasmTargetRuntime for eval_julia pipeline
let evalInstance = null;   // eval_julia.wasm instance (real pipeline)
const runBtn = document.getElementById("run-btn");
const statusEl = document.getElementById("status");
const outputEl = document.getElementById("output");

// ── CodeMirror editor ──
const editor = new EditorView({
  state: EditorState.create({
    doc: "1 + 1",
    extensions: [basicSetup],
  }),
  parent: document.getElementById("editor"),
});

// ── Load Wasm modules ──
async function loadWasm() {
  // Load eval_julia.wasm — the real Julia compiler pipeline
  rt = new WasmTargetRuntime();
  const evalPaths = [
    "eval_julia.wasm",
    "../browser/eval_julia.wasm",
  ];
  for (const path of evalPaths) {
    try {
      evalInstance = await rt.load(path, "eval_julia");
      console.log("Loaded eval_julia.wasm");
      break;
    } catch (e) {
      // Try next path
    }
  }

  // Load pipeline.wasm — fallback for expressions not yet handled by eval_julia
  const pipelinePaths = [
    "pipeline-optimized.wasm",
    "../scripts/pipeline-optimized.wasm",
    "pipeline.wasm",
    "../scripts/pipeline.wasm",
  ];
  for (const path of pipelinePaths) {
    try {
      const resp = await fetch(path);
      if (!resp.ok) continue;
      const bytes = await resp.arrayBuffer();
      const importObject = { Math: { pow: Math.pow } };
      const { instance } = await WebAssembly.instantiate(bytes, importObject);
      wasmInstance = instance;
      console.log(`Loaded pipeline.wasm (${(bytes.byteLength/1024).toFixed(0)} KB)`);
      break;
    } catch (e) {
      // Try next path
    }
  }

  if (evalInstance || wasmInstance) {
    const parts = [];
    if (evalInstance) parts.push("eval_julia pipeline");
    if (wasmInstance) parts.push("pipeline fallback");
    statusEl.textContent = `Ready (${parts.join(" + ")})`;
    statusEl.className = "status ready";
    runBtn.disabled = false;
  } else {
    statusEl.textContent = "Failed to load .wasm module. See console.";
    statusEl.className = "status error";
    console.error("Could not load any wasm module.");
  }
}

// ── Parse + evaluate ──
function evaluate(code) {
  const e = wasmInstance.exports;
  const trimmed = code.trim();

  // Match unary math functions: func(number)
  const unaryMatch = trimmed.match(/^(sin|cos|sqrt|abs|sign|sum_to|factorial|fib|isprime)\((-?\d+(?:\.\d+)?)\)$/);
  if (unaryMatch) {
    const fname = unaryMatch[1];
    const x = Number(unaryMatch[2]);
    const isFloat = unaryMatch[2].includes(".");
    if (fname === "sin") return String(e.pipeline_sin(x));
    if (fname === "cos") return String(e.pipeline_cos(x));
    if (fname === "sqrt") return String(e.pipeline_sqrt(x));
    if (fname === "abs" && isFloat) return String(e.pipeline_abs_f(x));
    if (fname === "abs" && !isFloat) return String(e.pipeline_abs_i(BigInt(Math.trunc(x))));
    // Phase 2: control flow + loops
    if (fname === "sign") return String(e.pipeline_sign(BigInt(Math.trunc(x))));
    if (fname === "sum_to") return String(e.pipeline_sum_to(BigInt(Math.trunc(x))));
    if (fname === "factorial") return String(e.pipeline_factorial(BigInt(Math.trunc(x))));
    if (fname === "fib") return String(e.pipeline_fib(BigInt(Math.trunc(x))));
    if (fname === "isprime") return String(e.pipeline_isprime(BigInt(Math.trunc(x))));
  }

  // Match unary negation: -number
  const negMatch = trimmed.match(/^-(\d+)$/);
  if (negMatch) {
    return String(e.pipeline_neg(BigInt(negMatch[1])));
  }

  // Match binary expressions: <number> <op> <number>
  const binMatch = trimmed.match(/^(-?\d+(?:\.\d+)?)\s*([+\-*/%])\s*(-?\d+(?:\.\d+)?)$/);
  if (binMatch) {
    const a = Number(binMatch[1]);
    const b = Number(binMatch[3]);
    const op = binMatch[2];
    const isFloat = binMatch[1].includes(".") || binMatch[3].includes(".");

    if (isFloat) {
      // Float path
      if (op === "+") return String(e.pipeline_fadd(a, b));
      if (op === "-") return String(e.pipeline_fsub(a, b));
      if (op === "*") return String(e.pipeline_fmul(a, b));
      if (op === "/") return String(e.pipeline_fdiv(a, b));
    } else {
      // Integer path — use BigInt exports
      const ai = BigInt(Math.trunc(a));
      const bi = BigInt(Math.trunc(b));
      if (op === "+") return String(e.pipeline_add(ai, bi));
      if (op === "-") return String(e.pipeline_sub(ai, bi));
      if (op === "*") return String(e.pipeline_mul(ai, bi));
      if (op === "/") return String(e.pipeline_div(ai, bi));
      if (op === "%") return String(e.pipeline_mod(ai, bi));
    }
  }

  // Match comparison: <number> == <number>
  const eqMatch = trimmed.match(/^(-?\d+)\s*==\s*(-?\d+)$/);
  if (eqMatch) {
    const ai = BigInt(eqMatch[1]);
    const bi = BigInt(eqMatch[2]);
    return String(e.pipeline_eq(ai, bi)) === "1" ? "true" : "false";
  }

  // Match two-arg integer functions: func(a, b)
  const twoArgMatch = trimmed.match(/^(max|min|div|mod|gcd|pow)\((-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)\)$/);
  if (twoArgMatch) {
    const fname = twoArgMatch[1];
    const isFloat = twoArgMatch[2].includes(".") || twoArgMatch[3].includes(".");
    if (isFloat) {
      const a = Number(twoArgMatch[2]);
      const b = Number(twoArgMatch[3]);
      if (fname === "max") return String(e.pipeline_fmax(a, b));
      if (fname === "min") return String(e.pipeline_fmin(a, b));
    }
    const ai = BigInt(twoArgMatch[2]);
    const bi = BigInt(twoArgMatch[3]);
    if (fname === "max") return String(e.pipeline_max(ai, bi));
    if (fname === "min") return String(e.pipeline_min(ai, bi));
    if (fname === "div") return String(e.pipeline_div(ai, bi));
    if (fname === "mod") return String(e.pipeline_mod(ai, bi));
    if (fname === "gcd") return String(e.pipeline_gcd(ai, bi));
    if (fname === "pow") return String(e.pipeline_pow(ai, bi));
  }

  // Match three-arg: clamp(x, lo, hi)
  const threeArgMatch = trimmed.match(/^clamp\((-?\d+),\s*(-?\d+),\s*(-?\d+)\)$/);
  if (threeArgMatch) {
    const x = BigInt(threeArgMatch[1]);
    const lo = BigInt(threeArgMatch[2]);
    const hi = BigInt(threeArgMatch[3]);
    return String(e.pipeline_clamp(x, lo, hi));
  }

  throw new Error(
    `Expression not yet supported.\n\nCurrently supported:\n` +
    `  Arithmetic: 1 + 1, 10 - 3, 2 * 3, 10 / 3, 10 % 3\n` +
    `  Float:      2.5 + 3.5, 2.5 * 4.0, 10.0 / 4.0\n` +
    `  Math:       sin(1.0), cos(0.0), sqrt(4.0), abs(-7)\n` +
    `  Control:    max(3, 7), min(3, 7), sign(-5), clamp(15, 1, 10)\n` +
    `  Compare:    3 == 3\n` +
    `  Loops:      sum_to(100), factorial(10), fib(20), pow(2, 10)\n` +
    `  Algorithms: gcd(100, 75), isprime(97)\n` +
    `\nFull Julia compilation coming in a future update.`
  );
}

// ── Run button ──
async function run() {
  const code = editor.state.doc.toString();
  outputEl.innerHTML = "";
  runBtn.disabled = true;

  try {
    let result;
    // Binary integer arithmetic (+, -, *): use real eval_julia pipeline
    const binIntMatch = code.trim().match(/^(-?\d+)\s*([+\-*])\s*(-?\d+)$/);
    if (evalInstance && binIntMatch) {
      result = String(await rt.evalJulia(evalInstance, code.trim()));
    } else if (wasmInstance) {
      // Fallback: pre-compiled pipeline.wasm for all other expressions
      result = evaluate(code);
    } else {
      throw new Error("No WASM module loaded.");
    }
    outputEl.innerHTML = `<span class="result">${escapeHtml(result)}</span>`;
  } catch (err) {
    outputEl.innerHTML = `<span class="error">${escapeHtml(err.message)}</span>`;
  } finally {
    runBtn.disabled = false;
  }
}

function escapeHtml(s) {
  return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

runBtn.addEventListener("click", run);

// Ctrl/Cmd+Enter to run
document.addEventListener("keydown", (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === "Enter" && !runBtn.disabled) {
    e.preventDefault();
    run();
  }
});

// Example snippets
document.querySelectorAll(".examples code[data-expr]").forEach((el) => {
  el.addEventListener("click", () => {
    const expr = el.getAttribute("data-expr");
    editor.dispatch({
      changes: { from: 0, to: editor.state.doc.length, insert: expr },
    });
  });
});

// ── Init ──
loadWasm();
</script>

</body>
</html>
